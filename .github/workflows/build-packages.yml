name: Build Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
        default: '1.0.0'

jobs:
  build-packages:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        include:
          - os: windows-latest
            platform: windows
            arch: x64
            ext: zip
          - os: macos-latest
            platform: macos
            arch: x64
            ext: tar.gz
          - os: macos-latest
            platform: macos
            arch: arm64
            ext: tar.gz
          - os: ubuntu-latest
            platform: linux
            arch: x64
            ext: tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.40.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'web/svelte/package-lock.json'

      - name: Install dependencies
        run: |
          cd web/svelte
          npm install

      - name: Build web UI
        run: |
          cd web/svelte
          npm run build

      - name: Run tests
        run: deno test -A

      - name: Build binary
        run: |
          deno compile -A --output rusty-gun src/main.ts

      - name: Create package
        shell: bash
        run: |
          # Create package directory
          mkdir -p package
          
          # Copy binary
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            cp rusty-gun.exe package/
          else
            cp rusty-gun package/
            chmod +x package/rusty-gun
          fi
          
          # Copy web UI
          cp -r web/dist package/web
          
          # Copy config files
          cp deno.json package/
          cp src/config.ts package/
          
          # Copy documentation
          cp README.md package/
          cp LICENSE package/
          
          # Create installer script
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            cat > package/install.bat << 'EOF'
          @echo off
          echo Installing Rusty Gun...
          echo.
          echo Rusty Gun is a P2P Graph Database with SQLite Compatibility
          echo.
          echo Features:
          echo - Local-first data storage
          echo - P2P synchronization
          echo - SQLite-compatible API
          echo - Vector search and embeddings
          echo - Encrypted data sharing
          echo - Cross-device sync
          echo - Comprehensive web UI
          echo.
          echo Starting Rusty Gun server...
          echo.
          echo Web UI will be available at: http://localhost:34568
          echo API will be available at: http://localhost:34567
          echo.
          echo Press Ctrl+C to stop the server
          echo.
          rusty-gun.exe serve --port 34567
          EOF
          else
            cat > package/install.sh << 'EOF'
          #!/bin/bash
          echo "Installing Rusty Gun..."
          echo ""
          echo "Rusty Gun is a P2P Graph Database with SQLite Compatibility"
          echo ""
          echo "Features:"
          echo "- Local-first data storage"
          echo "- P2P synchronization"
          echo "- SQLite-compatible API"
          echo "- Vector search and embeddings"
          echo "- Encrypted data sharing"
          echo "- Cross-device sync"
          echo "- Comprehensive web UI"
          echo ""
          echo "Starting Rusty Gun server..."
          echo ""
          echo "Web UI will be available at: http://localhost:34568"
          echo "API will be available at: http://localhost:34567"
          echo ""
          echo "Press Ctrl+C to stop the server"
          echo ""
          ./rusty-gun serve --port 34567
          EOF
            chmod +x package/install.sh
          fi
          
          # Create archive
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            cd package
            powershell Compress-Archive -Path * -DestinationPath ../rusty-gun-${{ matrix.platform }}-${{ matrix.arch }}.${{ matrix.ext }}
            cd ..
          else
            tar -czf rusty-gun-${{ matrix.platform }}-${{ matrix.arch }}.${{ matrix.ext }} -C package .
          fi

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: rusty-gun-${{ matrix.platform }}-${{ matrix.arch }}
          path: rusty-gun-${{ matrix.platform }}-${{ matrix.arch }}.${{ matrix.ext }}

  create-release:
    needs: build-packages
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packages/*/rusty-gun-*.zip
            packages/*/rusty-gun-*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-winget:
    needs: create-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update winget manifest
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # Update winget manifest
          sed -i "s/PackageVersion: .*/PackageVersion: $VERSION/" packaging/winget/rusty-gun.yaml
          sed -i "s|InstallerUrl: .*|InstallerUrl: https://github.com/rusty-gun/rusty-gun/releases/download/v$VERSION/rusty-gun-windows-x64.zip|" packaging/winget/rusty-gun.yaml
          
          # Calculate SHA256 (placeholder for now)
          sed -i "s/InstallerSha256: .*/InstallerSha256: PLACEHOLDER_SHA256/" packaging/winget/rusty-gun.yaml

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add packaging/winget/rusty-gun.yaml
          git commit -m "Update winget manifest for v${GITHUB_REF#refs/tags/v}" || exit 0
          git push
