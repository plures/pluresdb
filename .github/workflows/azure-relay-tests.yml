name: Azure Relay Tests

on:
  # Run on manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test (test, dev, prod)'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - dev
          - prod
      node_count:
        description: 'Number of nodes to deploy'
        required: false
        default: '3'
      skip_deployment:
        description: 'Skip infrastructure deployment (use existing)'
        required: false
        default: false
        type: boolean
  
  # Run on schedule (weekly for test environment)
  schedule:
    - cron: '0 2 * * 0' # Every Sunday at 2 AM UTC

permissions:
  id-token: write  # Required for OIDC authentication with Azure
  contents: read
  issues: write

env:
  AZURE_LOCATION: eastus

jobs:
  check-credentials:
    name: Check Azure Credentials
    runs-on: ubuntu-latest
    outputs:
      has_credentials: ${{ steps.check.outputs.has_credentials }}
      auth_type: ${{ steps.check.outputs.auth_type }}
    steps:
      - name: Check if Azure credentials are configured
        id: check
        run: |
          # Check for OIDC credentials (recommended)
          if [ -n "${{ secrets.AZURE_CLIENT_ID }}" ] && [ -n "${{ secrets.AZURE_TENANT_ID }}" ] && [ -n "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "has_credentials=true" >> $GITHUB_OUTPUT
            echo "auth_type=oidc" >> $GITHUB_OUTPUT
            echo "✓ Azure OIDC credentials are configured"
          # Fallback: Check for legacy AZURE_CREDENTIALS secret
          elif [ -n "${{ secrets.AZURE_CREDENTIALS }}" ]; then
            echo "has_credentials=true" >> $GITHUB_OUTPUT
            echo "auth_type=legacy" >> $GITHUB_OUTPUT
            echo "⚠️  Using legacy AZURE_CREDENTIALS secret (consider migrating to OIDC)"
          else
            echo "has_credentials=false" >> $GITHUB_OUTPUT
            echo "auth_type=none" >> $GITHUB_OUTPUT
            echo "⚠️  Azure credentials are not configured"
            echo "This workflow requires Azure OIDC credentials to be set."
            echo "See azure/docs/SECRETS.md for configuration instructions."
            echo ""
            echo "To configure OIDC (recommended):"
            echo "1. Create an Azure App Registration with federated credentials"
            echo "2. Add AZURE_CLIENT_ID, AZURE_TENANT_ID, and AZURE_SUBSCRIPTION_ID secrets"
            echo "3. Manually trigger this workflow or wait for the next scheduled run"
          fi

  deploy-infrastructure:
    name: Deploy Azure Infrastructure
    runs-on: ubuntu-latest
    needs: [check-credentials]
    # Skip if deployment is disabled OR if Azure credentials are not configured
    if: ${{ !inputs.skip_deployment && needs.check-credentials.outputs.has_credentials == 'true' }}
    outputs:
      resource_group: ${{ steps.deploy.outputs.resource_group }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        if: ${{ needs.check-credentials.outputs.auth_type == 'oidc' }}
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Azure Login (Legacy)
        if: ${{ needs.check-credentials.outputs.auth_type == 'legacy' }}
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set environment variables
        run: |
          ENV="${{ inputs.environment || 'test' }}"
          NODE_COUNT="${{ inputs.node_count || '3' }}"
          echo "ENVIRONMENT=${ENV}" >> $GITHUB_ENV
          echo "NODE_COUNT=${NODE_COUNT}" >> $GITHUB_ENV
          echo "RESOURCE_GROUP=pluresdb-${ENV}-rg" >> $GITHUB_ENV
      
      - name: Generate SSH key
        run: |
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
          echo "SSH_PUBLIC_KEY=$(cat ~/.ssh/id_rsa.pub)" >> $GITHUB_ENV
      
      - name: Deploy infrastructure
        id: deploy
        run: |
          cd azure/scripts
          chmod +x deploy.sh
          ./deploy.sh \
            --environment "${{ env.ENVIRONMENT }}" \
            --location "${{ env.AZURE_LOCATION }}" \
            --node-count "${{ env.NODE_COUNT }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --ssh-key "${{ env.SSH_PUBLIC_KEY }}"
          
          echo "resource_group=${{ env.RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
      
      - name: Wait for containers to start
        run: |
          echo "Waiting 60 seconds for containers to fully start..."
          sleep 60
      
      - name: Get node IP addresses
        id: get_ips
        run: |
          NODES=$(az container list \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "[].{name:name, ip:ipAddress.ip}" \
            --output json)
          
          echo "Deployed nodes:"
          echo "$NODES" | jq .
          
          # Export first node IP for quick access
          FIRST_IP=$(echo "$NODES" | jq -r '.[0].ip')
          echo "FIRST_NODE_IP=${FIRST_IP}" >> $GITHUB_ENV
      
      - name: Verify nodes are running
        run: |
          for i in {1..10}; do
            if curl -f "http://${{ env.FIRST_NODE_IP }}:34568/health" 2>/dev/null; then
              echo "✓ Node is healthy"
              exit 0
            fi
            echo "Attempt $i: Node not ready yet, waiting..."
            sleep 10
          done
          echo "❌ Node failed to become healthy"
          exit 1

  run-relay-tests:
    name: Run Relay Tests
    runs-on: ubuntu-latest
    needs: [check-credentials, deploy-infrastructure]
    if: always() && needs.check-credentials.outputs.has_credentials == 'true' && (needs.deploy-infrastructure.result == 'success' || inputs.skip_deployment)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x
      
      - name: Azure Login (OIDC)
        if: ${{ needs.check-credentials.outputs.auth_type == 'oidc' }}
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Azure Login (Legacy)
        if: ${{ needs.check-credentials.outputs.auth_type == 'legacy' }}
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set environment variables
        run: |
          ENV="${{ inputs.environment || 'test' }}"
          NODE_COUNT="${{ inputs.node_count || '3' }}"
          echo "ENVIRONMENT=${ENV}" >> $GITHUB_ENV
          echo "AZURE_NODE_COUNT=${NODE_COUNT}" >> $GITHUB_ENV
          echo "RESOURCE_GROUP=pluresdb-${ENV}-rg" >> $GITHUB_ENV
      
      - name: Get node IP addresses
        run: |
          NODES=$(az container list \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "[].ipAddress.ip" \
            --output tsv)
          
          # Convert to comma-separated list
          NODE_IPS=$(echo "$NODES" | tr '\n' ',' | sed 's/,$//')
          echo "AZURE_NODE_IPS=${NODE_IPS}" >> $GITHUB_ENV
          
          echo "Node IPs: ${NODE_IPS}"
          
          # Also set count for backwards compatibility
          NODE_COUNT=$(echo "$NODES" | wc -l)
          echo "AZURE_NODE_COUNT=${NODE_COUNT}" >> $GITHUB_ENV
      
      - name: Run relay integration tests
        run: |
          deno test \
            --allow-net \
            --allow-env \
            azure/tests/relay-tests.ts
      
      - name: Run performance benchmarks
        if: success() || failure()
        run: |
          echo "Running performance benchmarks..."
          # Future: Add dedicated performance test suite
          deno test \
            --allow-net \
            --allow-env \
            azure/tests/relay-tests.ts \
            --filter "Throughput\|Latency"
      
      - name: Generate test report
        if: always()
        run: |
          echo "# Azure Relay Test Report" > test-report.md
          echo "" >> test-report.md
          echo "**Environment**: ${{ env.ENVIRONMENT }}" >> test-report.md
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> test-report.md
          echo "**Node Count**: ${{ env.AZURE_NODE_COUNT }}" >> test-report.md
          echo "" >> test-report.md
          echo "## Test Results" >> test-report.md
          echo "See workflow logs for detailed results." >> test-report.md
      
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: azure-test-report
          path: test-report.md

  cleanup-infrastructure:
    name: Cleanup Azure Infrastructure
    runs-on: ubuntu-latest
    needs: [check-credentials, run-relay-tests]
    if: always() && needs.check-credentials.outputs.has_credentials == 'true' && !inputs.skip_deployment && inputs.environment == 'test'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        if: ${{ needs.check-credentials.outputs.auth_type == 'oidc' }}
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Azure Login (Legacy)
        if: ${{ needs.check-credentials.outputs.auth_type == 'legacy' }}
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set environment variables
        run: |
          ENV="${{ inputs.environment || 'test' }}"
          echo "ENVIRONMENT=${ENV}" >> $GITHUB_ENV
          echo "RESOURCE_GROUP=pluresdb-${ENV}-rg" >> $GITHUB_ENV
      
      - name: Destroy infrastructure
        run: |
          cd azure/scripts
          chmod +x destroy.sh
          ./destroy.sh \
            --environment "${{ env.ENVIRONMENT }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --confirm
      
      - name: Verify cleanup
        run: |
          # Wait a bit for deletion to propagate
          sleep 10
          
          if az group exists --name "${{ env.RESOURCE_GROUP }}" --output tsv | grep -q "false"; then
            echo "✓ Resource group successfully deleted"
          else
            echo "⚠ Resource group still exists (deletion may be in progress)"
          fi

  report-results:
    name: Report Test Results
    runs-on: ubuntu-latest
    needs: [check-credentials, run-relay-tests]
    # Report failure only if credentials are configured and tests actually ran and failed
    if: always() && needs.check-credentials.outputs.has_credentials == 'true' && needs.run-relay-tests.result == 'failure'
    
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Azure Relay Tests Failed - ${{ inputs.environment || 'test' }}`,
              body: `The Azure relay tests failed for the **${{ inputs.environment || 'test' }}** environment.
              
              **Details:**
              - Workflow: ${context.workflow}
              - Run ID: ${context.runId}
              - Environment: ${{ inputs.environment || 'test' }}
              - Node Count: ${{ inputs.node_count || '3' }}
              
              Please review the workflow logs:
              ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              **Next Steps:**
              1. Review test failures in the workflow logs
              2. Check Azure container logs for errors
              3. Verify network connectivity between nodes
              4. Review recent code changes that may have affected P2P relay
              
              **Related Documentation:**
              - [Test Plan](azure/docs/TEST_PLAN.md)
              - [Architecture](azure/docs/ARCHITECTURE.md)
              `,
              labels: ['bug', 'azure', 'relay', 'tests', 'ci']
            })

  notify-credentials-missing:
    name: Notify Missing Credentials
    runs-on: ubuntu-latest
    needs: [check-credentials]
    # Only run on scheduled triggers when credentials are missing
    if: github.event_name == 'schedule' && needs.check-credentials.outputs.has_credentials != 'true'
    
    steps:
      - name: Create issue for missing credentials
        uses: actions/github-script@v7
        with:
          script: |
            // Check if an issue already exists for this
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['azure', 'configuration'],
              per_page: 10
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Azure Credentials Not Configured')
            );
            
            if (existingIssue) {
              // Update existing issue with a comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Azure relay tests were skipped again on ${new Date().toISOString()} because credentials are not configured.\n\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
            } else {
              // Create new issue
              const body = 'The scheduled Azure relay tests are being skipped because Azure OIDC credentials are not configured.\n\n' +
                '**What happened:**\n' +
                '- The Azure relay tests are scheduled to run automatically (weekly on Sundays at 2 AM UTC)\n' +
                '- The workflow detected that Azure credentials are not configured\n' +
                '- All Azure deployment and testing jobs were skipped\n\n' +
                '**How to fix:**\n\n' +
                '### Option 1: Configure Azure OIDC Credentials (Recommended)\n\n' +
                'OIDC provides secretless authentication and is more secure than storing credentials.\n\n' +
                '1. Create an Azure App Registration with federated credentials:\n' +
                '   ```bash\n' +
                '   # Create the app registration\n' +
                '   az ad app create --display-name "pluresdb-github-actions"\n' +
                '   # Note the Application (client) ID from output\n' +
                '   \n' +
                '   # Create service principal\n' +
                '   az ad sp create --id <application-id>\n' +
                '   \n' +
                '   # Assign Contributor role\n' +
                '   az role assignment create \\\n' +
                '     --assignee <application-id> \\\n' +
                '     --role Contributor \\\n' +
                '     --scope /subscriptions/{subscription-id}\n' +
                '   \n' +
                '   # Add federated credential for GitHub Actions\n' +
                '   az ad app federated-credential create \\\n' +
                '     --id <application-id> \\\n' +
                '     --parameters \'{"name":"github-federated","issuer":"https://token.actions.githubusercontent.com","subject":"repo:plures/pluresdb:ref:refs/heads/main","audiences":["api://AzureADTokenExchange"]}\'\n' +
                '   ```\n\n' +
                '2. Add three repository secrets:\n' +
                '   - Go to Settings → Secrets and variables → Actions\n' +
                '   - Add `AZURE_CLIENT_ID` (Application/client ID)\n' +
                '   - Add `AZURE_TENANT_ID` (Directory/tenant ID)\n' +
                '   - Add `AZURE_SUBSCRIPTION_ID` (Subscription ID)\n\n' +
                '### Option 2: Disable Scheduled Tests\n\n' +
                'If you don\'t want to run Azure relay tests:\n\n' +
                '1. Edit `.github/workflows/azure-relay-tests.yml`\n' +
                '2. Comment out or remove the `schedule` trigger section\n\n' +
                '**Documentation:**\n' +
                '- [Azure Secrets Configuration Guide](azure/docs/SECRETS.md)\n' +
                '- [Test Plan](azure/docs/TEST_PLAN.md)\n\n' +
                `**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Azure Credentials Not Configured - Scheduled Tests Skipped',
                body: body,
                labels: ['configuration', 'azure', 'help wanted']
              });
            }
